name: Periodic E2E Monitoring

on:
  push:
    branches:
      - main
  schedule:
  - cron: '30 0,6,12,18 * * *'
  workflow_dispatch:
    # Allows manual triggering of the workflow

jobs:
  test:
    name: Run Playwright Tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          
      - name: Install dependencies
        run: npm ci || npm install
        
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
        
      - name: Run Playwright tests
        id: playwright
        run: |
          npx playwright test \
            tests/health_check/communitiful_main.test.ts \
            tests/health_check/github_page.test.ts \
            tests/health_check/user-journey_spec_netlify.test.ts
          
      - name: Upload Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Send E2E Email Notification
        uses: dawidd6/action-send-mail@v3
        if: always()
        with:
          # SMTP configuration
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
      
          # Email metadata
          from: "Communitiful Monitoring <${{ secrets.SMTP_USERNAME }}>"
          to: ${{ secrets.MAIL_TO }}
          subject: "Health Check Report â€” Communitiful"
    
          
          # Email body (Plain text / minimal Markdown)
          body: |
            End-to-End Monitoring Report
          
            Overall Status: Overall Status: ${{ job.status == 'success' && 'ðŸŸ¢ SUCCESS' || 'ðŸ”´ FAILURE' }}

            ${{ job.status == 'success'
            && 'All health checks have passed successfully. No issues were detected during this monitoring run.'
            || 'One or more health checks have failed during this monitoring run. Immediate attention may be required.' }}

          
            The scheduled end-to-end monitoring Health Check tests for Communitiful have completed.
            Below is a summary of the health checks executed during this run.
          
            Test Results Summary
          
            Communitiful Main Website
            Test File: tests/health_check/communitiful_main.test.ts
            Purpose: Verifies that https://communitiful.com is reachable and responding correctly.
          
            GitHub Pages Availability
            Test File: tests/health_check/github_page.test.ts
            Purpose: Ensures that the GitHub Pages site is accessible and loading as expected.
          
            Netlify End-to-End User Journey
            Test File: tests/health_check/user-journey_spec_netlify.test.ts
            Purpose: Validates that the complete end-to-end user flow on Netlify is functioning correctly.
          
            Action Run Details
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
            The Playwright HTML report can be viewed and downloaded from the Artifacts section of the action run.
          
            This is an automated monitoring notification from Communitiful.

      
          convert_markdown: true
          ignore_cert: true
      
